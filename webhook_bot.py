import os
import logging
import random
from openai import OpenAI
from telegram import Update, ReplyKeyboardMarkup, BotCommand
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler, 
    ContextTypes, filters
)

# –ò–º–ø–æ—Ä—Ç –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞
from memory_manager import add_analysis, delete_user_memory, load_memory
from dialog_handler import start_dialog, handle_dialog_step, user_dialog_state
from keyboard_handler import get_main_keyboard

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENAI_KEY = os.getenv("OPENAI_API_KEY")
WEBHOOK_URL = os.getenv("WEBHOOK_URL")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenAI
client = OpenAI(api_key=OPENAI_KEY)

# Telegram –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
application = ApplicationBuilder().token(TOKEN).build()

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_analysis_state = {}

# –ú–æ–¥–µ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
MODEL_SHORT = "gpt-3.5-turbo"  # –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
MODEL_ANALYSIS = "gpt-4"        # –¢–æ–ª—å–∫–æ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é OpenAI
async def generate_response(prompt, temperature=0.88, max_tokens=250, model=MODEL_SHORT):
    try:
        response = client.chat.completions.create(
            model=model,
            messages=[{"role": "user", "content": prompt}],
            temperature=temperature,
            max_tokens=max_tokens
        )
        return response.choices[0].message.content
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: {e}")
        fallback_responses = [
            "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑?",
            "–ú–æ–∏ –Ω–µ–π—Ä–æ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–≥—Ä–µ–ª–∏—Å—å. –î–∞–π –º–Ω–µ —Å–µ–∫—É–Ω–¥—É.",
            "–£–ø—Å, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —à—É–º—ã. –ú–æ–∂–µ—à—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å?",
            "–ò–∑–≤–∏–Ω–∏, —è –æ—Ç–≤–ª—ë–∫—Å—è. –û —á—ë–º –º—ã –≥–æ–≤–æ—Ä–∏–ª–∏?",
            "–ú–æ–∑–≥ –∑–∞–≤–∏—Å. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é—Å—å..."
        ]
        return random.choice(fallback_responses)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ –¥–ª—è –±–æ—Ç–∞
async def setup_commands(context: ContextTypes.DEFAULT_TYPE):
    commands = [
        BotCommand("start", "–ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –í–æ–≤–æ–π"),
        BotCommand("analyze", "–†–∞–∑–±–æ—Ä –ø–æ –º–µ—Ç–æ–¥—É –†–≠–ü–¢ –∏ –ê–°–¢ —Ç–µ—Ä–∞–ø–∏–∏"),
        BotCommand("talk", "–¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–æ –ø–æ–±–æ–ª—Ç–∞—Ç—å"),
        BotCommand("summary", "–õ–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ—Å—Ç–∞"),
        BotCommand("clear", "–ù–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞"),
        BotCommand("help", "–ü–æ–¥—Å–∫–∞–∑–∫–∞, –∫—Ç–æ —Ç–∞–∫–æ–π –í–æ–≤–∞ –∏ –∫–∞–∫ —Å –Ω–∏–º –æ–±—â–∞—Ç—å—Å—è")
    ]
    await context.bot.set_my_commands(commands)

# –ö–æ–º–∞–Ω–¥–∞ /start - –Ω–∞—á–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}")
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –±–æ—Ç–∞ –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
    await setup_commands(context)
    
    prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –≤ —Å—Ç–∏–ª–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º-–±–ª–æ–≥–µ—Ä–∞ @zapiskirizhego.
    –ù–∞–ø–∏—à–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª —Ç–µ–±—è.
    
    –¢–≤–æ–π —Å—Ç–∏–ª—å:
    - –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π, –Ω–æ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π
    - –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    - –ò–Ω–æ–≥–¥–∞ —Å —Å–∞–º–æ–∏—Ä–æ–Ω–∏–µ–π
    - –ë–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–µ–∂–ª–∏–≤–æ—Å—Ç–µ–π –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π
    - –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–Ω–≥, –Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ
    - –ì–æ–≤–æ—Ä–∏—à—å –∫–∞–∫ —É–º–Ω—ã–π –¥—Ä—É–≥, –∞ –Ω–µ –∫–∞–∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç
    
    –í –∫–æ–Ω—Ü–µ –Ω–∞–ø–æ–º–Ω–∏, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:
    ‚Ä¢ /analyze –∏–ª–∏ –∫–Ω–æ–ø–∫—É "üß† –ê–Ω–∞–ª–∏–∑" ‚Äî —Ä–∞–∑–±–æ—Ä –ø–æ –º–µ—Ç–æ–¥—É –†–≠–ü–¢ –∏ –ê–°–¢ —Ç–µ—Ä–∞–ø–∏–∏
    ‚Ä¢ /talk –∏–ª–∏ –∫–Ω–æ–ø–∫—É "üí¨ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å" ‚Äî —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–æ –ø–æ–±–æ–ª—Ç–∞—Ç—å
    ‚Ä¢ /summary –∏–ª–∏ –∫–Ω–æ–ø–∫—É "üìä –í—ã–≤–æ–¥—ã" ‚Äî –ª–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ—Å—Ç–∞
    ‚Ä¢ /clear –∏–ª–∏ –∫–Ω–æ–ø–∫—É "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é" ‚Äî –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞

    –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ –∑–≤—É—á–∞—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ."""
    
    welcome_text = await generate_response(prompt)
    await update.message.reply_text(welcome_text, reply_markup=get_main_keyboard())

# –ö–æ–º–∞–Ω–¥–∞ /help - –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ—Ç
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /help –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}")
    
    prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º-–±–ª–æ–≥–µ—Ä–∞ @zapiskirizhego.
    –ù–∞–ø–∏—à–∏ –ø–æ–Ω—è—Ç–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º –∏ –∫–∞–∫–∏–µ —É –Ω–µ–≥–æ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏.
    
    –í–∫–ª—é—á–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ:
    1. –ö—Ç–æ —Ç–∞–∫–æ–π –í–æ–≤–∞ (–ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–π –±–æ—Ç —Å –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–º —Å—Ç–∏–ª–µ–º)
    2. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
       - /analyze –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "üß† –ê–Ω–∞–ª–∏–∑" ‚Äî —Ä–∞–∑–±–æ—Ä –ø–æ –º–µ—Ç–æ–¥—É –†–≠–ü–¢ –∏ –ê–°–¢ —Ç–µ—Ä–∞–ø–∏–∏
       - /talk –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "üí¨ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å" ‚Äî —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–æ –ø–æ–±–æ–ª—Ç–∞—Ç—å
       - /summary –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "üìä –í—ã–≤–æ–¥—ã" ‚Äî –ª–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ—Å—Ç–∞
       - /clear –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é" ‚Äî –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
    3. –ß—Ç–æ –í–æ–≤–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–º–µ–Ω–æ–π –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∞
    
    –ü–∏—à–∏ –≤ —Å–≤–æ–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ–º —Å—Ç–∏–ª–µ ‚Äî –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ, —Å –Ω–µ–±–æ–ª—å—à–æ–π –¥–µ—Ä–∑–æ—Å—Ç—å—é, –Ω–æ –∑–∞–±–æ—Ç–ª–∏–≤–æ.
    –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫ –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."""
    
    help_text = await generate_response(prompt, temperature=0.85, max_tokens=500)
    await update.message.reply_text(help_text)

# –ö–æ–º–∞–Ω–¥–∞ /analyze - –Ω–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –±–µ—Å–µ–¥—ã
async def analyze_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /analyze –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}")
    user_id = update.effective_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
    user_message = update.message.text.replace("/analyze", "").strip()
    
    if not user_message:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –≤–≤–µ–ª –∫–æ–º–∞–Ω–¥—É –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
        prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π, 
        –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã –≤—ã—è—Å–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞. –ì–æ–≤–æ—Ä–∏ —Ç–∞–∫, –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã 
        –Ω–µ–º–Ω–æ–≥–æ –¥–µ—Ä–∑–∫–∏–π, –Ω–æ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π –¥—Ä—É–≥. –ú–∞–∫—Å–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."""
        
        request_text = await generate_response(prompt, temperature=0.9, max_tokens=80)
        await update.message.reply_text(request_text)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞
        user_analysis_state[user_id] = {
            "stage": "waiting_for_request",
            "request": None,
            "emotions": None,
            "thoughts": None,
            "cognitive_distortions": None,
            "history": []
        }
        return
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∞–Ω–∞–ª–∏–∑–∞
    if user_id in user_analysis_state:
        current_stage = user_analysis_state[user_id]["stage"]
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ
        if current_stage == "waiting_for_request":
            user_analysis_state[user_id]["request"] = user_message
            user_analysis_state[user_id]["stage"] = "waiting_for_emotions"
            
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —ç–º–æ—Ü–∏–∏
            prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego. 
            –ö–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ–ø–∏—Å–∞–ª —Å–≤–æ—é –ø—Ä–æ–±–ª–µ–º—É. –ó–∞–¥–∞–π –µ–º—É –ø—Ä—è–º–æ–π –≤–æ–ø—Ä–æ—Å –æ–± —ç–º–æ—Ü–∏—è—Ö, 
            –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç –≤ —Å–≤—è–∑–∏ —Å —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –≥–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ, 
            –º–∞–∫—Å–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî –¥–µ—Ä–∑–∫–∏–π, –Ω–æ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π –¥—Ä—É–≥."""
            
            emotions_question = await generate_response(prompt, temperature=0.85, max_tokens=80)
            user_analysis_state[user_id]["history"].append({"role": "user", "content": user_message})
            user_analysis_state[user_id]["history"].append({"role": "assistant", "content": emotions_question})
            await update.message.reply_text(emotions_question)
            
        elif current_stage == "waiting_for_emotions":
            user_analysis_state[user_id]["emotions"] = user_message
            user_analysis_state[user_id]["stage"] = "waiting_for_thoughts"
            
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º—ã—Å–ª–∏
            prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego. 
            –ö–ª–∏–µ–Ω—Ç —Ä–∞—Å—Å–∫–∞–∑–∞–ª –æ —Å–≤–æ–∏—Ö —ç–º–æ—Ü–∏—è—Ö. –¢–µ–ø–µ—Ä—å —Å–ø—Ä–æ—Å–∏ –µ–≥–æ –æ –º—ã—Å–ª—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ 
            —Å—Ç–æ—è—Ç –∑–∞ —ç—Ç–∏–º–∏ —ç–º–æ—Ü–∏—è–º–∏. –ü–æ–ø—Ä–æ—Å–∏ –≤—ã–¥–µ–ª–∏—Ç—å —Å–∞–º—É—é –ø–µ—Ä–≤—É—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –º—ã—Å–ª—å. 
            –ì–æ–≤–æ—Ä–∏ –ø—Ä—è–º–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, –∫–∞–∫ –¥–µ—Ä–∑–∫–∏–π, –Ω–æ —É–º–Ω—ã–π –¥—Ä—É–≥."""
            
            thoughts_question = await generate_response(prompt, temperature=0.85, max_tokens=80)
            user_analysis_state[user_id]["history"].append({"role": "user", "content": user_message})
            user_analysis_state[user_id]["history"].append({"role": "assistant", "content": thoughts_question})
            await update.message.reply_text(thoughts_question)
            
        elif current_stage == "waiting_for_thoughts":
            user_analysis_state[user_id]["thoughts"] = user_message
            user_analysis_state[user_id]["stage"] = "waiting_for_distortions"
            
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è
            prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego. 
            –ö–ª–∏–µ–Ω—Ç —Ä–∞—Å—Å–∫–∞–∑–∞–ª –æ —Å–≤–æ–∏—Ö –º—ã—Å–ª—è—Ö. –¢–µ–ø–µ—Ä—å —Å–ø—Ä–æ—Å–∏ –µ–≥–æ, –∫–∞–∫–∏–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è 
            –æ–Ω –≤–∏–¥–∏—Ç –≤ —Å–≤–æ–∏—Ö –º—ã—Å–ª—è—Ö. –ú–æ–∂–µ—à—å –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å 2-3 —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏—Å–∫–∞–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ 
            (–∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏–∑–∞—Ü–∏—è, —á–µ—Ä–Ω–æ-–±–µ–ª–æ–µ –º—ã—à–ª–µ–Ω–∏–µ, —á—Ç–µ–Ω–∏–µ –º—ã—Å–ª–µ–π –∏ —Ç.–¥.). –ì–æ–≤–æ—Ä–∏ –≤ —Å–≤–æ—ë–º —Ñ–∏—Ä–º–µ–Ω–Ω–æ–º 
            –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ–º, –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–æ–º —Å—Ç–∏–ª–µ."""
            
            distortions_question = await generate_response(prompt, temperature=0.9, max_tokens=120)
            user_analysis_state[user_id]["history"].append({"role": "user", "content": user_message})
            user_analysis_state[user_id]["history"].append({"role": "assistant", "content": distortions_question})
            await update.message.reply_text(distortions_question)
            
        elif current_stage == "waiting_for_distortions":
            user_analysis_state[user_id]["cognitive_distortions"] = user_message
            user_analysis_state[user_id]["stage"] = "completed"
            user_analysis_state[user_id]["history"].append({"role": "user", "content": user_message})
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
            request = user_analysis_state[user_id]["request"]
            emotions = user_analysis_state[user_id]["emotions"]
            thoughts = user_analysis_state[user_id]["thoughts"]
            cognitive_distortions = user_analysis_state[user_id]["cognitive_distortions"]
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            analysis_prompt = f"""–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –≤ —Å—Ç–∏–ª–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ 
            –∏–Ω—Å—Ç–∞–≥—Ä–∞–º-–±–ª–æ–≥–µ—Ä–∞ @zapiskirizhego. –ü—Ä–æ–≤–µ–¥–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ –º–µ—Ç–æ–¥–∞–º –†–≠–ü–¢ –∏ –ê–°–¢ —Ç–µ—Ä–∞–ø–∏–∏ 
            –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–µ—Å–µ–¥—ã —Å –∫–ª–∏–µ–Ω—Ç–æ–º.

            –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:
            - –ü—Ä–æ–±–ª–µ–º–∞/–∑–∞–ø—Ä–æ—Å: {request}
            - –≠–º–æ—Ü–∏–∏: {emotions}
            - –ú—ã—Å–ª–∏: {thoughts}
            - –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è: {cognitive_distortions}
            
            –¢–≤–æ–π —Å—Ç–∏–ª—å:
            - –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π, –Ω–æ —Å –∑–∞–±–æ—Ç–æ–π
            - –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
            - –ë–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–µ–∂–ª–∏–≤–æ—Å—Ç–µ–π –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π
            - –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–Ω–≥, –Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ
            - –ì–æ–≤–æ—Ä–∏—à—å –∫–∞–∫ —É–º–Ω—ã–π –¥—Ä—É–≥, –∞ –Ω–µ –∫–∞–∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç
            - –ò–Ω–æ–≥–¥–∞ –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π, —á—Ç–æ–±—ã –∑–∞—Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥—É–º–∞—Ç—å—Å—è
            
            –í —Å–≤–æ–µ–º –∞–Ω–∞–ª–∏–∑–µ:
            1. –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ —Å–≤—è–∑—å –º–µ–∂–¥—É –º—ã—Å–ª—è–º–∏, —ç–º–æ—Ü–∏—è–º–∏ –∏ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–º–∏ –∏—Å–∫–∞–∂–µ–Ω–∏—è–º–∏ –∫–ª–∏–µ–Ω—Ç–∞
            2. –ü—Ä–µ–¥–ª–æ–∂–∏ 1-2 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ, –±–æ–ª–µ–µ —Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º—ã—Å–ª–∏
            3. –î–∞–π 1-2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ –ê–°–¢ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π
            4. –ó–∞–≤–µ—Ä—à–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π, –Ω–æ –Ω–µ –±–∞–Ω–∞–ª—å–Ω–æ–π —Ñ—Ä–∞–∑–æ–π
            
            –û–±—â–∞—è –¥–ª–∏–Ω–∞: 250-350 —Å–ª–æ–≤, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –Ω–∞ 3-4 –∞–±–∑–∞—Ü–∞."""
            
            final_analysis = await generate_response(analysis_prompt, temperature=0.85, max_tokens=800, model=MODEL_ANALYSIS)
            user_analysis_state[user_id]["history"].append({"role": "assistant", "content": final_analysis})
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å –∞–Ω–∞–ª–∏–∑ –≤ –ø–∞–º—è—Ç–∏
            full_conversation = "\n".join([f"{'–í–æ–≤–∞' if item['role'] == 'assistant' else '–ö–ª–∏–µ–Ω—Ç'}: {item['content']}" 
                                          for item in user_analysis_state[user_id]["history"]])
            add_analysis(user_id, request, full_conversation)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
            await update.message.reply_text(final_analysis)
            
            # –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞
            del user_analysis_state[user_id]
    else:
        # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–µ–∫—Å—Ç–æ–º
        thinking_prompt = """–ù–∞–ø–∏—à–∏ –æ–¥–Ω—É –∫–æ—Ä–æ—Ç–∫—É—é —Ñ—Ä–∞–∑—É (–Ω–µ –±–æ–ª–µ–µ 5-7 —Å–ª–æ–≤) –≤ —Å—Ç–∏–ª–µ @zapiskirizhego, 
        –∫–æ—Ç–æ—Ä–æ–π –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –º–æ–≥ –±—ã –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–∞—á–∞–ª–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ë—É–¥—å –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–º."""
        
        thinking = await generate_response(thinking_prompt, temperature=0.95, max_tokens=30)
        await update.message.reply_text(thinking)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
        user_analysis_state[user_id] = {
            "stage": "waiting_for_emotions",
            "request": user_message,
            "emotions": None,
            "thoughts": None,
            "cognitive_distortions": None,
            "history": [{"role": "user", "content": user_message}]
        }
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —ç–º–æ—Ü–∏–∏
        prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego. 
        –ö–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ–ø–∏—Å–∞–ª —Å–≤–æ—é –ø—Ä–æ–±–ª–µ–º—É. –ó–∞–¥–∞–π –µ–º—É –ø—Ä—è–º–æ–π –≤–æ–ø—Ä–æ—Å –æ–± —ç–º–æ—Ü–∏—è—Ö, 
        –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç –≤ —Å–≤—è–∑–∏ —Å —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –≥–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ, 
        –º–∞–∫—Å–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî –¥–µ—Ä–∑–∫–∏–π, –Ω–æ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π –¥—Ä—É–≥."""
        
        emotions_question = await generate_response(prompt, temperature=0.85, max_tokens=80)
        user_analysis_state[user_id]["history"].append({"role": "assistant", "content": emotions_question})
        await update.message.reply_text(emotions_question)

# –ö–æ–º–∞–Ω–¥–∞ /talk - –Ω–∞—á–∞–ª–æ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
async def talk_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /talk –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}")
    await start_dialog(update, context)

# –ö–æ–º–∞–Ω–¥–∞ /summary - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
async def summary_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /summary –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}")
    
    user_id = str(update.effective_user.id)
    memory = load_memory()
    
    if user_id not in memory or not memory[user_id]:
        prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego. –ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Ç–µ–±—è 
        —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥—ã –æ –Ω—ë–º –∏ –µ–≥–æ –ª–∏—á–Ω–æ—Å—Ç–∏, –Ω–æ —É —Ç–µ–±—è –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ —Å –Ω–∏–º. –û—Ç–≤–µ—Ç—å –∫–æ—Ä–æ—Ç–∫–æ, 
        –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ, –Ω–æ —Å –∑–∞–±–æ—Ç–æ–π. –°–∫–∞–∂–∏, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 
        –∫–æ–º–∞–Ω–¥—ã /analyze –∏–ª–∏ /talk –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞."""
        
        no_data_message = await generate_response(prompt, temperature=0.9, max_tokens=100)
        await update.message.reply_text(no_data_message)
        return
    
    # –°–æ–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    history = memory[user_id]
    history_text = "\n".join([f"–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {item['input']}\n–ê–Ω–∞–ª–∏–∑: {item['response']}" for item in history[-5:]])
    
    # –ó–∞–ø—Ä–æ—Å –∫ OpenAI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏
    prompt = f"""–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º-–±–ª–æ–≥–µ—Ä–∞ @zapiskirizhego. 
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–¥–µ–ª–∞–π –≤—ã–≤–æ–¥—ã –æ –µ–≥–æ –ª–∏—á–Ω–æ—Å—Ç–∏, –≥–ª–∞–≤–Ω—ã—Ö —Ç–µ–º–∞—Ö –∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö —Ä–∞–∑–≤–∏—Ç–∏—è.
    –≠—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏—Å–∫—Ä–µ–Ω–Ω–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –Ω–æ –Ω–µ –ª—å—Å—Ç–∏–≤—ã–π –∞–Ω–∞–ª–∏–∑.
    
    –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤:
    {history_text}
    
    –¢–≤–æ–π —Å—Ç–∏–ª—å:
    - –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π, –Ω–æ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π
    - –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    - –ë–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–µ–∂–ª–∏–≤–æ—Å—Ç–µ–π –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π
    - –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–Ω–≥, –Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ
    - –ì–æ–≤–æ—Ä–∏—à—å –∫–∞–∫ —É–º–Ω—ã–π –¥—Ä—É–≥, –∞ –Ω–µ –∫–∞–∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç
    - –ò–Ω–æ–≥–¥–∞ –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π, —á—Ç–æ–±—ã –∑–∞—Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥—É–º–∞—Ç—å—Å—è
    
    –í —Å–≤–æ–µ–º –∞–Ω–∞–ª–∏–∑–µ:
    1. –û–ø–∏—à–∏ –∑–∞–º–µ—Ç–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö (–±–µ–∑ —è–≤–Ω—ã—Ö –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤)
    2. –í—ã–¥–µ–ª–∏ –≥–ª–∞–≤–Ω—ã–µ —Ç–µ–º—ã –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–Ω—ã –∏–∑ –æ–±—â–µ–Ω–∏—è
    3. –£–∫–∞–∂–∏ –æ–±–ª–∞—Å—Ç–∏, –≥–¥–µ –≤–∏–¥–∏—à—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è (–±–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è)
    4. –ü—Ä–µ–¥–ª–æ–∂–∏ 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞ –∏–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ —Å–æ–±–æ–π
    5. –ó–∞–≤–µ—Ä—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º, –∫–æ—Ç–æ—Ä—ã–π –∑–≤—É—á–∏—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ
    
    –û–±—â–∞—è –¥–ª–∏–Ω–∞: 250-350 —Å–ª–æ–≤, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –Ω–∞ 3-4 –∞–±–∑–∞—Ü–∞."""
    
    try:
        reply = await generate_response(prompt, temperature=0.87, max_tokens=800, model=MODEL_SHORT)
    except Exception as e:
        error_prompt = """–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego, 
        –æ–±—ä—è—Å–Ω—è—é—â–µ–µ, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ –Ω–µ —É–¥–∞–ª—Å—è. 
        –ë—É–¥—å –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–º, –Ω–æ –Ω–µ –≥—Ä—É–±—ã–º."""
        
        reply = await generate_response(error_prompt, temperature=0.9, max_tokens=80)
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: {e}")
    
    await update.message.reply_text(reply)

# –ö–æ–º–∞–Ω–¥–∞ /clear - —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def clear_history_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /clear –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}")
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    user_id = update.effective_user.id
    if user_id in user_analysis_state:
        del user_analysis_state[user_id]
    
    success = delete_user_memory(user_id)
    
    if success:
        prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego. –ö–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏–ª —É–¥–∞–ª–∏—Ç—å 
        –∏—Å—Ç–æ—Ä–∏—é –≤–∞—à–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –∏ —Ç—ã —ç—Ç–æ —Å–¥–µ–ª–∞–ª. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —Å–≤–æ—ë–º 
        –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ–º —Å—Ç–∏–ª–µ, —Å –Ω–µ–±–æ–ª—å—à–æ–π –º–µ—Ç–∞—Ñ–æ—Ä–æ–π –æ "–Ω–æ–≤–æ–º –Ω–∞—á–∞–ª–µ" –∏–ª–∏ "—á–∏—Å—Ç–æ–º –ª–∏—Å—Ç–µ"."""
    else:
        prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego. –ö–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏–ª —É–¥–∞–ª–∏—Ç—å 
        –∏—Å—Ç–æ—Ä–∏—é –≤–∞—à–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –Ω–æ –Ω–∏–∫–∞–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏ –Ω–µ –±—ã–ª–æ. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–≤–æ—ë–º 
        –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ–º —Å—Ç–∏–ª–µ —Å –ª–µ–≥–∫–æ–π –∏—Ä–æ–Ω–∏–µ–π, –æ–±—ä—è—Å–Ω—è—é—â–µ–µ, —á—Ç–æ —É–¥–∞–ª—è—Ç—å –±—ã–ª–æ –Ω–µ—á–µ–≥–æ."""
    
    reply = await generate_response(prompt, temperature=0.9, max_tokens=80)
    await update.message.reply_text(reply)

# –ö–æ–º–∞–Ω–¥–∞ /about - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /about –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}")
    
    prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç-–±–æ—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º-–±–ª–æ–≥–µ—Ä–∞ @zapiskirizhego. 
    –ù–∞–ø–∏—à–∏ –æ —Å–µ–±–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (150-200 —Å–ª–æ–≤) –≤ –ø–µ—Ä–≤–æ–º –ª–∏—Ü–µ.
    
    –¢–≤–æ–π —Å—Ç–∏–ª—å:
    - –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π, –Ω–æ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π
    - –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    - –ë–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–µ–∂–ª–∏–≤–æ—Å—Ç–µ–π –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π
    - –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–Ω–≥, –Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ
    - –ì–æ–≤–æ—Ä–∏—à—å –∫–∞–∫ —É–º–Ω—ã–π –¥—Ä—É–≥, –∞ –Ω–µ –∫–∞–∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç
    - –ò–Ω–æ–≥–¥–∞ –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π
    
    –í–∫–ª—é—á–∏:
    1. –ö—Ç–æ —Ç—ã –∏ —á—Ç–æ –¥–µ–ª–∞–µ—à—å (–ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–π –±–æ—Ç)
    2. –¢–≤–æ–π –ø–æ–¥—Ö–æ–¥ (–†–≠–ü–¢ –∏ –ê–°–¢ —Ç–µ—Ä–∞–ø–∏—è)
    3. –ö–∞–∫ —Ç—ã –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å –ª—é–¥—è–º
    4. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, —á—Ç–æ —Ç—ã –Ω–µ –∑–∞–º–µ–Ω—è–µ—à—å –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
    
    –ì–æ–≤–æ—Ä–∏ —Å–≤–æ–±–æ–¥–Ω–æ, —Å —Å–∞–º–æ–∏—Ä–æ–Ω–∏–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."""
    
    about_text = await generate_response(prompt, temperature=0.87, max_tokens=450)
    await update.message.reply_text(about_text)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    message_text = update.message.text
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —Å —ç–º–æ–¥–∑–∏
    if message_text == "üß† –ê–Ω–∞–ª–∏–∑":
        update.message.text = "/analyze"
        await analyze_command(update, context)
        return
    elif message_text == "üí¨ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å":
        update.message.text = "/talk"
        await talk_command(update, context)
        return
    elif message_text == "üìä –í—ã–≤–æ–¥—ã":
        update.message.text = "/summary"
        await summary_command(update, context)
        return
    elif message_text == "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é":
        update.message.text = "/clear"
        await clear_history_command(update, context)
        return
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–∏–∞–ª–æ–≥–∞
    if user_id in user_dialog_state:
        await handle_dialog_step(update, context)
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∞–Ω–∞–ª–∏–∑–∞
    elif user_id in user_analysis_state:
        await analyze_command(update, context)
    else:
        # –ò–Ω–∞—á–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–∞—á–∞—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
        prompt = """–¢—ã –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç-–±–æ—Ç –ø–æ –∏–º–µ–Ω–∏ –í–æ–≤–∞ –≤ —Å—Ç–∏–ª–µ @zapiskirizhego. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª 
        —Ç–µ–±–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–º–∞–Ω–¥—ã. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –≤ —Å–≤–æ—ë–º –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ–º —Å—Ç–∏–ª–µ, 
        –≤ –∫–æ—Ç–æ—Ä–æ–º –ø—Ä–µ–¥–ª–æ–∂–∏—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã /analyze –∏–ª–∏ /talk –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞."""
        
        suggestion = await generate_response(prompt, temperature=0.9, max_tokens=80)
        await update.message.reply_text(suggestion, reply_markup=get_main_keyboard())

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
def register_handlers():
    # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("analyze", analyze_command))
    application.add_handler(CommandHandler("talk", talk_command))
    application.add_handler(CommandHandler("summary", summary_command))
    application.add_handler(CommandHandler("clear", clear_history_command))
    application.add_handler(CommandHandler("about", about_command))
    application.add_handler(CommandHandler("help", help_command))
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    logger.info("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥...")
    register_handlers()
    
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å –≤–µ–±—Ö—É–∫–æ–º...")
    application.run_webhook(
        listen="0.0.0.0",
        port=10000,
        webhook_url=WEBHOOK_URL,
        url_path="webhook"  # –ü—É—Ç—å –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏ URL –≤ WEBHOOK_URL
    )
    logger.info(f"–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å –≤–µ–±—Ö—É–∫–æ–º –Ω–∞ {WEBHOOK_URL}")
